----------------------------------------------------------------------------
-- LuaJIT ARM disassembler module.
--
-- Copyright (C) 2005-2022 Mike Pall. All rights reserved.
-- Released under the MIT license. See Copyright Notice in luajit.h
----------------------------------------------------------------------------
local type=type;local a,b,c=string.sub,string.byte,string.format;local d,e=string.match,string.gmatch;local f=table.concat;local g=require("bit")local h,i,j,k=g.band,g.bor,g.ror,g.tohex;local l,m,n=g.lshift,g.rshift,g.arshift;local o={shift=8,mask=15,[10]={shift=20,mask=1,[0]={shift=23,mask=3,[0]="vmovFmDN","vstmFNdr",_={shift=21,mask=1,[0]="vstrFdl",{shift=16,mask=15,[13]="vpushFdr",_="vstmdbFNdr"}}},{shift=23,mask=3,[0]="vmovFDNm",{shift=16,mask=15,[13]="vpopFdr",_="vldmFNdr"},_={shift=21,mask=1,[0]="vldrFdl","vldmdbFNdr"}}},[11]={shift=20,mask=1,[0]={shift=23,mask=3,[0]="vmovGmDN","vstmGNdr",_={shift=21,mask=1,[0]="vstrGdl",{shift=16,mask=15,[13]="vpushGdr",_="vstmdbGNdr"}}},{shift=23,mask=3,[0]="vmovGDNm",{shift=16,mask=15,[13]="vpopGdr",_="vldmGNdr"},_={shift=21,mask=1,[0]="vldrGdl","vldmdbGNdr"}}},_={shift=0,mask=0}}local p={shift=6,mask=0x2c001,[0]="vmlaF.dnm","vmlsF.dnm",[0x04000]="vnmlsF.dnm",[0x04001]="vnmlaF.dnm",[0x08000]="vmulF.dnm",[0x08001]="vnmulF.dnm",[0x0c000]="vaddF.dnm",[0x0c001]="vsubF.dnm",[0x20000]="vdivF.dnm",[0x24000]="vfnmsF.dnm",[0x24001]="vfnmaF.dnm",[0x28000]="vfmaF.dnm",[0x28001]="vfmsF.dnm",[0x2c000]="vmovF.dY",[0x2c001]={shift=7,mask=0x1e01,[0]="vmovF.dm","vabsF.dm",[0x0200]="vnegF.dm",[0x0201]="vsqrtF.dm",[0x0800]="vcmpF.dm",[0x0801]="vcmpeF.dm",[0x0a00]="vcmpzF.d",[0x0a01]="vcmpzeF.d",[0x0e01]="vcvtG.dF.m",[0x1000]="vcvt.f32.u32Fdm",[0x1001]="vcvt.f32.s32Fdm",[0x1800]="vcvtr.u32F.dm",[0x1801]="vcvt.u32F.dm",[0x1a00]="vcvtr.s32F.dm",[0x1a01]="vcvt.s32F.dm"}}local q={shift=6,mask=0x2c001,[0]="vmlaG.dnm","vmlsG.dnm",[0x04000]="vnmlsG.dnm",[0x04001]="vnmlaG.dnm",[0x08000]="vmulG.dnm",[0x08001]="vnmulG.dnm",[0x0c000]="vaddG.dnm",[0x0c001]="vsubG.dnm",[0x20000]="vdivG.dnm",[0x24000]="vfnmsG.dnm",[0x24001]="vfnmaG.dnm",[0x28000]="vfmaG.dnm",[0x28001]="vfmsG.dnm",[0x2c000]="vmovG.dY",[0x2c001]={shift=7,mask=0x1e01,[0]="vmovG.dm","vabsG.dm",[0x0200]="vnegG.dm",[0x0201]="vsqrtG.dm",[0x0800]="vcmpG.dm",[0x0801]="vcmpeG.dm",[0x0a00]="vcmpzG.d",[0x0a01]="vcmpzeG.d",[0x0e01]="vcvtF.dG.m",[0x1000]="vcvt.f64.u32GdFm",[0x1001]="vcvt.f64.s32GdFm",[0x1800]="vcvtr.u32FdG.m",[0x1801]="vcvt.u32FdG.m",[0x1a00]="vcvtr.s32FdG.m",[0x1a01]="vcvt.s32FdG.m"}}local r={shift=24,mask=1,[0]={shift=4,mask=1,[0]={shift=8,mask=15,[10]=p,[11]=q},{shift=8,mask=15,[10]={shift=20,mask=15,[0]="vmovFnD","vmovFDn",[14]="vmsrD",[15]={shift=12,mask=15,[15]="vmrs",_="vmrsD"}}}},"svcT"}local s={shift=0,mask=0}local t={shift=0,mask=0}local u={shift=0,mask=0}local v={shift=0,mask=0}local w={shift=0,mask=0}local x={shift=20,mask=31,[0]=false,{shift=5,mask=7,[0]="sadd16DNM","sasxDNM","ssaxDNM","ssub16DNM","sadd8DNM",false,false,"ssub8DNM"},{shift=5,mask=7,[0]="qadd16DNM","qasxDNM","qsaxDNM","qsub16DNM","qadd8DNM",false,false,"qsub8DNM"},{shift=5,mask=7,[0]="shadd16DNM","shasxDNM","shsaxDNM","shsub16DNM","shadd8DNM",false,false,"shsub8DNM"},false,{shift=5,mask=7,[0]="uadd16DNM","uasxDNM","usaxDNM","usub16DNM","uadd8DNM",false,false,"usub8DNM"},{shift=5,mask=7,[0]="uqadd16DNM","uqasxDNM","uqsaxDNM","uqsub16DNM","uqadd8DNM",false,false,"uqsub8DNM"},{shift=5,mask=7,[0]="uhadd16DNM","uhasxDNM","uhsaxDNM","uhsub16DNM","uhadd8DNM",false,false,"uhsub8DNM"},{shift=5,mask=7,[0]="pkhbtDNMU",false,"pkhtbDNMU",{shift=16,mask=15,[15]="sxtb16DMU",_="sxtab16DNMU"},"pkhbtDNMU","selDNM","pkhtbDNMU"},false,{shift=5,mask=7,[0]="ssatDxMu","ssat16DxM","ssatDxMu",{shift=16,mask=15,[15]="sxtbDMU",_="sxtabDNMU"},"ssatDxMu",false,"ssatDxMu"},{shift=5,mask=7,[0]="ssatDxMu","revDM","ssatDxMu",{shift=16,mask=15,[15]="sxthDMU",_="sxtahDNMU"},"ssatDxMu","rev16DM","ssatDxMu"},{shift=5,mask=7,[3]={shift=16,mask=15,[15]="uxtb16DMU",_="uxtab16DNMU"}},false,{shift=5,mask=7,[0]="usatDwMu","usat16DwM","usatDwMu",{shift=16,mask=15,[15]="uxtbDMU",_="uxtabDNMU"},"usatDwMu",false,"usatDwMu"},{shift=5,mask=7,[0]="usatDwMu","rbitDM","usatDwMu",{shift=16,mask=15,[15]="uxthDMU",_="uxtahDNMU"},"usatDwMu","revshDM","usatDwMu"},{shift=12,mask=15,[15]={shift=5,mask=7,"smuadNMS","smuadxNMS","smusdNMS","smusdxNMS"},_={shift=5,mask=7,[0]="smladNMSD","smladxNMSD","smlsdNMSD","smlsdxNMSD"}},false,false,false,{shift=5,mask=7,[0]="smlaldDNMS","smlaldxDNMS","smlsldDNMS","smlsldxDNMS"},{shift=5,mask=7,[0]={shift=12,mask=15,[15]="smmulNMS",_="smmlaNMSD"},{shift=12,mask=15,[15]="smmulrNMS",_="smmlarNMSD"},false,false,false,false,"smmlsNMSD","smmlsrNMSD"},false,false,{shift=5,mask=7,[0]={shift=12,mask=15,[15]="usad8NMS",_="usada8NMSD"}},false,{shift=5,mask=3,[2]="sbfxDMvw"},{shift=5,mask=3,[2]="sbfxDMvw"},{shift=5,mask=3,[0]={shift=0,mask=15,[15]="bfcDvX",_="bfiDMvX"}},{shift=5,mask=3,[0]={shift=0,mask=15,[15]="bfcDvX",_="bfiDMvX"}},{shift=5,mask=3,[2]="ubfxDMvw"},{shift=5,mask=3,[2]="ubfxDMvw"}}local y={shift=21,mask=9,{shift=20,mask=5,[0]="strtDL","ldrtDL",[4]="strbtDL",[5]="ldrbtDL"},_={shift=20,mask=5,[0]="strDL","ldrDL",[4]="strbDL",[5]="ldrbDL"}}local z={shift=4,mask=1,[0]=y,x}local A={shift=20,mask=1,[0]={shift=23,mask=3,[0]="stmdaNR","stmNR",{shift=16,mask=63,[45]="pushR",_="stmdbNR"},"stmibNR"},{shift=23,mask=3,[0]="ldmdaNR",{shift=16,mask=63,[61]="popR",_="ldmNR"},"ldmdbNR","ldmibNR"}}local B={shift=21,mask=15,[0]="andDNPs","eorDNPs","subDNPs","rsbDNPs","addDNPs","adcDNPs","sbcDNPs","rscDNPs","tstNP","teqNP","cmpNP","cmnNP","orrDNPs","movDPs","bicDNPs","mvnDPs"}local C={shift=21,mask=7,[0]="mulNMSs","mlaNMSDs","umaalDNMS","mlsDNMS","umullDNMSs","umlalDNMSs","smullDNMSs","smlalDNMSs"}local D={shift=20,mask=15,[0]="swpDMN",false,false,false,"swpbDMN",false,false,false,"strexDMN","ldrexDN","strexdDN","ldrexdDN","strexbDMN","ldrexbDN","strexhDN","ldrexhDN"}local E={shift=21,mask=3,[0]={shift=5,mask=3,[0]="smlabbNMSD","smlatbNMSD","smlabtNMSD","smlattNMSD"},{shift=5,mask=3,[0]="smlawbNMSD","smulwbNMS","smlawtNMSD","smulwtNMS"},{shift=5,mask=3,[0]="smlalbbDNMS","smlaltbDNMS","smlalbtDNMS","smlalttDNMS"},{shift=5,mask=3,[0]="smulbbNMS","smultbNMS","smulbtNMS","smulttNMS"}}local F={shift=4,mask=7,[0]={shift=21,mask=1,[0]="mrsD","msrM"},{shift=21,mask=3,"bxM",false,"clzDM"},{shift=21,mask=3,"bxjM"},{shift=21,mask=3,"blxM"},false,{shift=21,mask=3,[0]="qaddDMN","qsubDMN","qdaddDMN","qdsubDMN"},false,{shift=21,mask=3,"bkptK"}}local G={shift=4,mask=9,[9]={shift=5,mask=3,[0]={shift=24,mask=1,[0]=C,D},{shift=20,mask=1,[0]="strhDL","ldrhDL"},{shift=20,mask=1,[0]="ldrdDL","ldrsbDL"},{shift=20,mask=1,[0]="strdDL","ldrshDL"}},_={shift=20,mask=25,[16]={shift=7,mask=1,[0]=F,E},_={shift=0,mask=0xffffffff,[i(0xe1a00000)]="nop",_=B}}}local H={shift=20,mask=31,[16]="movwDW",[20]="movtDW",[18]={shift=0,mask=0xf00ff,[0]="nopv6",_="msrNW"},[22]="msrNW",_=B}local I={shift=24,mask=1,[0]="bB","blB"}local J={[0]=G,H,y,z,A,I,o,r}local K={[0]=false,u,v,w,false,"blxB",s,t}local L={[0]="r0","r1","r2","r3","r4","r5","r6","r7","r8","r9","r10","r11","r12","sp","lr","pc"}local M={[0]="eq","ne","hs","lo","mi","pl","vs","vc","hi","ls","ge","lt","gt","le","al"}local N={[0]="lsl","lsr","asr","ror"}local function O(P,Q,R)local S=P.pos;local T=""if P.rel then local U=P.symtab[P.rel]if U then T="\t->"..U elseif h(P.op,0x0e000000)~=0x0a000000 then T="\t; 0x"..k(P.rel)end end;if P.hexdump>0 then P.out(c("%08x  %s  %-5s %s%s\n",P.addr+S,k(P.op),Q,f(R,", "),T))else P.out(c("%08x  %-5s %s%s\n",P.addr+S,Q,f(R,", "),T))end;P.pos=S+4 end;local function V(P)return O(P,".long",{"0x"..k(P.op)})end;local function W(P,X,S)local Y=L[h(m(X,16),15)]local Z,_;local a0=h(X,0x04000000)==0;if not a0 and h(X,0x02000000)==0 then _=h(X,4095)if h(X,0x00800000)==0 then _=-_ end;if Y=="pc"then P.rel=P.addr+S+8+_ end;_="#".._ elseif a0 and h(X,0x00400000)~=0 then _=h(X,15)+h(m(X,4),0xf0)if h(X,0x00800000)==0 then _=-_ end;if Y=="pc"then P.rel=P.addr+S+8+_ end;_="#".._ else _=L[h(X,15)]if a0 or h(X,0xfe0)==0 then elseif h(X,0xfe0)==0x60 then _=c("%s, rrx",_)else local a1=h(m(X,7),31)if a1==0 then a1=32 end;_=c("%s, %s #%d",_,N[h(m(X,5),3)],a1)end;if h(X,0x00800000)==0 then _="-".._ end end;if _=="#0"then Z=c("[%s]",Y)elseif h(X,0x01000000)==0 then Z=c("[%s], %s",Y,_)else Z=c("[%s, %s]",Y,_)end;if h(X,0x01200000)==0x01200000 then Z=Z.."!"end;return Z end;local function a2(P,X,S)local Y=L[h(m(X,16),15)]local _=h(X,255)*4;if h(X,0x00800000)==0 then _=-_ end;if Y=="pc"then P.rel=P.addr+S+8+_ end;if _==0 then return c("[%s]",Y)else return c("[%s, #%d]",Y,_)end end;local function a3(X,a4,a5,a6)if a4=="s"then return c("s%d",2*h(m(X,a5),15)+h(m(X,a6),1))else return c("d%d",h(m(X,a5),15)+h(m(X,a6-4),16))end end;local function a7(P)local S=P.pos;local a8,a9,aa,ab=b(P.code,S+1,S+4)local X=i(l(ab,24),l(aa,16),l(a9,8),a8)local R={}local ac=""local ad,ae,af;local a4;P.op=X;P.rel=nil;local ag=m(X,28)local ah;if ag==15 then ah=K[h(m(X,25),7)]else if ag~=14 then ac=M[ag]end;ah=J[h(m(X,25),7)]end;while type(ah)~="string"do if not ah then return V(P)end;ah=ah[h(m(X,ah.shift),ah.mask)]or ah._ end;ae,af=d(ah,"^([a-z0-9]*)(.*)")if a(af,1,1)=="."then local ai,aj=d(af,"^([a-z0-9.]*)(.*)")ac=ac..ai;af=aj end;for ak in e(af,".")do local Z=nil;if ak=="D"then Z=L[h(m(X,12),15)]elseif ak=="N"then Z=L[h(m(X,16),15)]elseif ak=="S"then Z=L[h(m(X,8),15)]elseif ak=="M"then Z=L[h(X,15)]elseif ak=="d"then Z=a3(X,a4,12,22)elseif ak=="n"then Z=a3(X,a4,16,7)elseif ak=="m"then Z=a3(X,a4,0,5)elseif ak=="P"then if h(X,0x02000000)~=0 then Z=j(h(X,255),2*h(m(X,8),15))else Z=L[h(X,15)]if h(X,0xff0)~=0 then R[#R+1]=Z;local al=N[h(m(X,5),3)]local am=nil;if h(X,0xf90)==0 then if al=="ror"then al="rrx"else am="#32"end elseif h(X,0x10)==0 then am="#"..h(m(X,7),31)else am=L[h(m(X,8),15)]end;if ae=="mov"then ae=al;Z=am elseif am then Z=c("%s %s",al,am)else Z=al end end end elseif ak=="L"then Z=W(P,X,S)elseif ak=="l"then Z=a2(P,X,S)elseif ak=="B"then local an=P.addr+S+8+n(l(X,8),6)if ag==15 then an=an+h(m(X,23),2)end;P.rel=an;Z="0x"..k(an)elseif ak=="F"then a4="s"elseif ak=="G"then a4="d"elseif ak=="."then ac=ac..(a4=="s"and".f32"or".f64")elseif ak=="R"then if h(X,0x00200000)~=0 and#R==1 then R[1]=R[1].."!"end;local ao={}for ap=0,15 do if h(m(X,ap),1)==1 then ao[#ao+1]=L[ap]end end;Z="{"..f(ao,", ").."}"elseif ak=="r"then if h(X,0x00200000)~=0 and#R==2 then R[1]=R[1].."!"end;local al=tonumber(a(ad,2))local aq=h(X,255)if a4=="d"then aq=m(aq,1)end;R[#R]=c("{%s-%s%d}",ad,a4,al+aq-1)elseif ak=="W"then Z=h(X,0x0fff)+h(m(X,4),0xf000)elseif ak=="T"then Z="#0x"..k(h(X,0x00ffffff),6)elseif ak=="U"then Z=h(m(X,7),31)if Z==0 then Z=nil end elseif ak=="u"then Z=h(m(X,7),31)if h(X,0x40)==0 then if Z==0 then Z=nil else Z="lsl #"..Z end else if Z==0 then Z="asr #32"else Z="asr #"..Z end end elseif ak=="v"then Z=h(m(X,7),31)elseif ak=="w"then Z=h(m(X,16),31)elseif ak=="x"then Z=h(m(X,16),31)+1 elseif ak=="X"then Z=h(m(X,16),31)-ad+1 elseif ak=="Y"then Z=h(m(X,12),0xf0)+h(X,0x0f)elseif ak=="K"then Z="#0x"..k(h(m(X,4),0x0000fff0)+h(X,15),4)elseif ak=="s"then if h(X,0x00100000)~=0 then ac="s"..ac end else assert(false)end;if Z then ad=Z;if type(Z)=="number"then Z="#"..Z end;R[#R+1]=Z end end;return O(P,ae..ac,R)end;local function ar(P,_,as)if not _ then _=0 end;local at=as and _+as or#P.code;P.pos=_;P.rel=nil;while P.pos<at do a7(P)end end;local function au(av,an,aw)local P={}P.code=av;P.addr=an or 0;P.out=aw or io.write;P.symtab={}P.disass=ar;P.hexdump=8;return P end;local function ax(av,an,aw)au(av,an,aw):disass()end;local function ay(am)if am<16 then return L[am]end;return"d"..am-16 end;return{create=au,disass=ax,regname=ay}