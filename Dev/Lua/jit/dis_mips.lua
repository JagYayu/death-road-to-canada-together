----------------------------------------------------------------------------
-- LuaJIT MIPS disassembler module.
--
-- Copyright (C) 2005-2022 Mike Pall. All rights reserved.
-- Released under the MIT/X license. See Copyright Notice in luajit.h
----------------------------------------------------------------------------
local type=type;local a,b=string.byte,string.format;local c,d=string.match,string.gmatch;local e=table.concat;local f=require("bit")local g,h,i=f.band,f.bor,f.tohex;local j,k,l=f.lshift,f.rshift,f.arshift;local m={shift=21,mask=1,[0]="srlDTA","rotrDTA"}local n={shift=6,mask=1,[0]="srlvDTS","rotrvDTS"}local o={shift=25,mask=1,[0]={shift=21,mask=15,[0]="mfc0TDW",[4]="mtc0TDW",[10]="rdpgprDT",[11]={shift=5,mask=1,[0]="diT0","eiT0"},[14]="wrpgprDT"},{shift=0,mask=63,[1]="tlbr",[2]="tlbwi",[6]="tlbwr",[8]="tlbp",[24]="eret",[31]="deret",[32]="wait"}}local p={shift=16,mask=1,[0]="movfDSC","movtDSC"}local q={shift=0,mask=63,[0]={shift=0,mask=-1,[0]="nop",_="sllDTA"},p,m,"sraDTA","sllvDTS",false,n,"sravDTS","jrS","jalrD1S","movzDST","movnDST","syscallY","breakY",false,"sync","mfhiD","mthiS","mfloD","mtloS","dsllvDST",false,"dsrlvDST","dsravDST","multST","multuST","divST","divuST","dmultST","dmultuST","ddivST","ddivuST","addDST","addu|moveDST0","subDST","subu|neguDS0T","andDST","or|moveDST0","xorDST","nor|notDST0",false,false,"sltDST","sltuDST","daddDST","dadduDST","dsubDST","dsubuDST","tgeSTZ","tgeuSTZ","tltSTZ","tltuSTZ","teqSTZ",false,"tneSTZ",false,"dsllDTA",false,"dsrlDTA","dsraDTA","dsll32DTA",false,"dsrl32DTA","dsra32DTA"}local r={shift=0,mask=63,[0]="maddST","madduST","mulDST",false,"msubST","msubuST",[32]="clzDS",[33]="cloDS",[63]="sdbbpY"}local s={shift=6,mask=31,[2]="wsbhDT",[16]="sebDT",[24]="sehDT"}local t={shift=6,mask=31,[2]="dsbhDT",[5]="dshdDT"}local u={shift=0,mask=63,[0]="extTSAK",[1]="dextmTSAP",[3]="dextTSAK",[4]="insTSAL",[6]="dinsuTSEQ",[7]="dinsTSAL",[32]=s,[36]=t,[59]="rdhwrTD"}local v={shift=16,mask=31,[0]="bltzSB","bgezSB","bltzlSB","bgezlSB",false,false,false,false,"tgeiSI","tgeiuSI","tltiSI","tltiuSI","teqiSI",false,"tneiSI",false,"bltzalSB","bgezalSB","bltzallSB","bgezallSB",false,false,false,false,false,false,false,false,false,false,false,"synciSO"}local w={shift=0,mask=63,[0]="add.sFGH","sub.sFGH","mul.sFGH","div.sFGH","sqrt.sFG","abs.sFG","mov.sFG","neg.sFG","round.l.sFG","trunc.l.sFG","ceil.l.sFG","floor.l.sFG","round.w.sFG","trunc.w.sFG","ceil.w.sFG","floor.w.sFG",false,{shift=16,mask=1,[0]="movf.sFGC","movt.sFGC"},"movz.sFGT","movn.sFGT",false,"recip.sFG","rsqrt.sFG",false,false,false,false,false,false,false,false,false,false,"cvt.d.sFG",false,false,"cvt.w.sFG","cvt.l.sFG","cvt.ps.sFGH",false,false,false,false,false,false,false,false,false,"c.f.sVGH","c.un.sVGH","c.eq.sVGH","c.ueq.sVGH","c.olt.sVGH","c.ult.sVGH","c.ole.sVGH","c.ule.sVGH","c.sf.sVGH","c.ngle.sVGH","c.seq.sVGH","c.ngl.sVGH","c.lt.sVGH","c.nge.sVGH","c.le.sVGH","c.ngt.sVGH"}local x={shift=0,mask=63,[0]="add.dFGH","sub.dFGH","mul.dFGH","div.dFGH","sqrt.dFG","abs.dFG","mov.dFG","neg.dFG","round.l.dFG","trunc.l.dFG","ceil.l.dFG","floor.l.dFG","round.w.dFG","trunc.w.dFG","ceil.w.dFG","floor.w.dFG",false,{shift=16,mask=1,[0]="movf.dFGC","movt.dFGC"},"movz.dFGT","movn.dFGT",false,"recip.dFG","rsqrt.dFG",false,false,false,false,false,false,false,false,false,"cvt.s.dFG",false,false,false,"cvt.w.dFG","cvt.l.dFG",false,false,false,false,false,false,false,false,false,false,"c.f.dVGH","c.un.dVGH","c.eq.dVGH","c.ueq.dVGH","c.olt.dVGH","c.ult.dVGH","c.ole.dVGH","c.ule.dVGH","c.df.dVGH","c.ngle.dVGH","c.deq.dVGH","c.ngl.dVGH","c.lt.dVGH","c.nge.dVGH","c.le.dVGH","c.ngt.dVGH"}local y={shift=0,mask=63,[0]="add.psFGH","sub.psFGH","mul.psFGH",false,false,"abs.psFG","mov.psFG","neg.psFG",false,false,false,false,false,false,false,false,false,{shift=16,mask=1,[0]="movf.psFGC","movt.psFGC"},"movz.psFGT","movn.psFGT",false,false,false,false,false,false,false,false,false,false,false,false,"cvt.s.puFG",false,false,false,false,false,false,false,"cvt.s.plFG",false,false,false,"pll.psFGH","plu.psFGH","pul.psFGH","puu.psFGH","c.f.psVGH","c.un.psVGH","c.eq.psVGH","c.ueq.psVGH","c.olt.psVGH","c.ult.psVGH","c.ole.psVGH","c.ule.psVGH","c.psf.psVGH","c.ngle.psVGH","c.pseq.psVGH","c.ngl.psVGH","c.lt.psVGH","c.nge.psVGH","c.le.psVGH","c.ngt.psVGH"}local z={shift=0,mask=63,[32]="cvt.s.wFG",[33]="cvt.d.wFG"}local A={shift=0,mask=63,[32]="cvt.s.lFG",[33]="cvt.d.lFG"}local B={shift=16,mask=3,[0]="bc1fCB","bc1tCB","bc1flCB","bc1tlCB"}local C={shift=21,mask=31,[0]="mfc1TG","dmfc1TG","cfc1TG","mfhc1TG","mtc1TG","dmtc1TG","ctc1TG","mthc1TG",B,false,false,false,false,false,false,false,w,x,false,false,z,A,y}local D={shift=0,mask=63,[0]="lwxc1FSX","ldxc1FSX",false,false,false,"luxc1FSX",false,false,"swxc1FSX","sdxc1FSX",false,false,false,"suxc1FSX",false,"prefxMSX",false,false,false,false,false,false,false,false,false,false,false,false,false,false,"alnv.psFGHS",false,"madd.sFRGH","madd.dFRGH",false,false,false,false,"madd.psFRGH",false,"msub.sFRGH","msub.dFRGH",false,false,false,false,"msub.psFRGH",false,"nmadd.sFRGH","nmadd.dFRGH",false,false,false,false,"nmadd.psFRGH",false,"nmsub.sFRGH","nmsub.dFRGH",false,false,false,false,"nmsub.psFRGH",false}local E={[0]=q,v,"jJ","jalJ","beq|beqz|bST00B","bne|bnezST0B","blezSB","bgtzSB","addiTSI","addiu|liTS0I","sltiTSI","sltiuTSI","andiTSU","ori|liTS0U","xoriTSU","luiTU",o,C,false,D,"beql|beqzlST0B","bnel|bnezlST0B","blezlSB","bgtzlSB","daddiTSI","daddiuTSI",false,false,r,"jalxJ",false,u,"lbTSO","lhTSO","lwlTSO","lwTSO","lbuTSO","lhuTSO","lwrTSO",false,"sbTSO","shTSO","swlTSO","swTSO",false,false,"swrTSO","cacheNSO","llTSO","lwc1HSO","lwc2TSO","prefNSO",false,"ldc1HSO","ldc2TSO","ldTSO","scTSO","swc1HSO","swc2TSO",false,false,"sdc1HSO","sdc2TSO","sdTSO"}local F={shift=6,mask=3,[2]="mulDST",[3]="muhDST"}local G={shift=6,mask=3,[2]="muluDST",[3]="muhuDST"}local H={shift=6,mask=3,[2]="divDST",[3]="modDST"}local I={shift=6,mask=3,[2]="divuDST",[3]="moduDST"}local J={shift=6,mask=3,[2]="dmulDST",[3]="dmuhDST"}local K={shift=6,mask=3,[2]="dmuluDST",[3]="dmuhuDST"}local L={shift=6,mask=3,[2]="ddivDST",[3]="dmodDST"}local M={shift=6,mask=3,[2]="ddivuDST",[3]="dmoduDST"}local N={shift=0,mask=63,[0]={shift=0,mask=-1,[0]="nop",_="sllDTA"},false,m,"sraDTA","sllvDTS",false,n,"sravDTS","jrS","jalrD1S",false,false,"syscallY","breakY",false,"sync","clzDS","cloDS","dclzDS","dcloDS","dsllvDST","dlsaDSTA","dsrlvDST","dsravDST",F,G,H,I,J,K,L,M,"addDST","addu|moveDST0","subDST","subu|neguDS0T","andDST","or|moveDST0","xorDST","nor|notDST0",false,false,"sltDST","sltuDST","daddDST","dadduDST","dsubDST","dsubuDST","tgeSTZ","tgeuSTZ","tltSTZ","tltuSTZ","teqSTZ","seleqzDST","tneSTZ","selnezDST","dsllDTA",false,"dsrlDTA","dsraDTA","dsll32DTA",false,"dsrl32DTA","dsra32DTA"}local O={shift=9,mask=3,[1]="alignDSTa",_={shift=6,mask=31,[0]="bitswapDT",[2]="wsbhDT",[16]="sebDT",[24]="sehDT"}}local P={shift=9,mask=3,[1]="dalignDSTa",_={shift=6,mask=31,[0]="dbitswapDT",[2]="dsbhDT",[5]="dshdDT"}}local Q={shift=0,mask=63,[0]="extTSAK",[1]="dextmTSAP",[3]="dextTSAK",[4]="insTSAL",[6]="dinsuTSEQ",[7]="dinsTSAL",[32]=O,[36]=P,[59]="rdhwrTD"}local R={shift=16,mask=31,[0]="bltzSB",[1]="bgezSB",[6]="dahiSI",[30]="datiSI",[23]="sigrieI",[31]="synciSO"}local S={shift=19,mask=3,[0]="addiupcS2","lwpcS2","lwupcS2",{shift=18,mask=1,[0]="ldpcS3",{shift=16,mask=3,[2]="auipcSI",[3]="aluipcSI"}}}local T={shift=0,mask=63,[0]="add.sFGH","sub.sFGH","mul.sFGH","div.sFGH","sqrt.sFG","abs.sFG","mov.sFG","neg.sFG","round.l.sFG","trunc.l.sFG","ceil.l.sFG","floor.l.sFG","round.w.sFG","trunc.w.sFG","ceil.w.sFG","floor.w.sFG","sel.sFGH",false,false,false,"seleqz.sFGH","recip.sFG","rsqrt.sFG","selnez.sFGH","maddf.sFGH","msubf.sFGH","rint.sFG","class.sFG","min.sFGH","mina.sFGH","max.sFGH","maxa.sFGH",false,"cvt.d.sFG",false,false,"cvt.w.sFG","cvt.l.sFG"}local U={shift=0,mask=63,[0]="add.dFGH","sub.dFGH","mul.dFGH","div.dFGH","sqrt.dFG","abs.dFG","mov.dFG","neg.dFG","round.l.dFG","trunc.l.dFG","ceil.l.dFG","floor.l.dFG","round.w.dFG","trunc.w.dFG","ceil.w.dFG","floor.w.dFG","sel.dFGH",false,false,false,"seleqz.dFGH","recip.dFG","rsqrt.dFG","selnez.dFGH","maddf.dFGH","msubf.dFGH","rint.dFG","class.dFG","min.dFGH","mina.dFGH","max.dFGH","maxa.dFGH","cvt.s.dFG",false,false,false,"cvt.w.dFG","cvt.l.dFG"}local V={shift=0,mask=63,[0]="cmp.af.sFGH","cmp.un.sFGH","cmp.eq.sFGH","cmp.ueq.sFGH","cmp.lt.sFGH","cmp.ult.sFGH","cmp.le.sFGH","cmp.ule.sFGH","cmp.saf.sFGH","cmp.sun.sFGH","cmp.seq.sFGH","cmp.sueq.sFGH","cmp.slt.sFGH","cmp.sult.sFGH","cmp.sle.sFGH","cmp.sule.sFGH",false,"cmp.or.sFGH","cmp.une.sFGH","cmp.ne.sFGH",false,false,false,false,false,"cmp.sor.sFGH","cmp.sune.sFGH","cmp.sne.sFGH",false,false,false,false,"cvt.s.wFG","cvt.d.wFG"}local W={shift=0,mask=63,[0]="cmp.af.dFGH","cmp.un.dFGH","cmp.eq.dFGH","cmp.ueq.dFGH","cmp.lt.dFGH","cmp.ult.dFGH","cmp.le.dFGH","cmp.ule.dFGH","cmp.saf.dFGH","cmp.sun.dFGH","cmp.seq.dFGH","cmp.sueq.dFGH","cmp.slt.dFGH","cmp.sult.dFGH","cmp.sle.dFGH","cmp.sule.dFGH",false,"cmp.or.dFGH","cmp.une.dFGH","cmp.ne.dFGH",false,false,false,false,false,"cmp.sor.dFGH","cmp.sune.dFGH","cmp.sne.dFGH",false,false,false,false,"cvt.s.lFG","cvt.d.lFG"}local X={shift=21,mask=31,[0]="mfc1TG","dmfc1TG","cfc1TG","mfhc1TG","mtc1TG","dmtc1TG","ctc1TG","mthc1TG",false,"bc1eqzHB",false,false,false,"bc1nezHB",false,false,T,U,false,false,V,W}local function Y(Z,_)if _==0 then return 0 elseif Z==0 then return 1 elseif Z==_ then return 2 else return 3 end end;local a0={maprs=Y,[0]="blezSB","blezalcTB","bgezalcTB","bgeucSTB"}local a1={maprs=Y,[0]="bgtzSB","bgtzalcTB","bltzalcTB","bltucSTB"}local a2={maprs=Y,"blezcTB","bgezcTB","bgecSTB"}local a3={maprs=Y,"bgtzcTB","bltzcTB","bltcSTB"}local function a4(Z,_)if Z==0 then return 0 else return 1 end end;local a5={maprs=a4,[0]="jicTI","beqzcSb"}local a6={maprs=a4,[0]="jialcTI","bnezcSb"}local function a7(Z,_)if Z>=_ then return 0 elseif Z==0 then return 1 else return 2 end end;local a8={maprs=a7,[0]="bovcSTB","beqzalcTB","beqcSTB"}local a9={maprs=a7,[0]="bnvcSTB","bnezalcTB","bnecSTB"}local aa={[0]=N,R,"jJ","jalJ","beq|beqz|bST00B","bne|bnezST0B",a0,a1,a8,"addiu|liTS0I","sltiTSI","sltiuTSI","andiTSU","ori|liTS0U","xoriTSU","aui|luiTS0U",o,X,false,false,false,false,a2,a3,a9,"daddiuTSI",false,false,false,"dauiTSI",false,Q,"lbTSO","lhTSO",false,"lwTSO","lbuTSO","lhuTSO",false,false,"sbTSO","shTSO",false,"swTSO",false,false,false,false,false,"lwc1HSO","bc#",false,false,"ldc1HSO",a5,"ldTSO",false,"swc1HSO","balc#",S,false,"sdc1HSO",a6,"sdTSO"}local ab={[0]="r0","r1","r2","r3","r4","r5","r6","r7","r8","r9","r10","r11","r12","r13","r14","r15","r16","r17","r18","r19","r20","r21","r22","r23","r24","r25","r26","r27","r28","sp","r30","ra"}local function ac(ad,ae,af)local ag=ad.pos;local ah=""if ad.rel then local ai=ad.symtab[ad.rel]if ai then ah="\t->"..ai end end;if ad.hexdump>0 then ad.out(b("%08x  %s  %-7s %s%s\n",ad.addr+ag,i(ad.op),ae,e(af,", "),ah))else ad.out(b("%08x  %-7s %s%s\n",ad.addr+ag,ae,e(af,", "),ah))end;ad.pos=ag+4 end;local function aj(ad)return ac(ad,".long",{"0x"..i(ad.op)})end;local function ak(ad)local ag=ad.pos;local al,am,an,ao=a(ad.code,ag+1,ag+4)return h(j(al,24),j(am,16),j(an,8),ao)end;local function ap(ad)local ag=ad.pos;local al,am,an,ao=a(ad.code,ag+1,ag+4)return h(j(ao,24),j(an,16),j(am,8),al)end;local function aq(ad)local ar=ad:get()local af={}local as=nil;ad.op=ar;ad.rel=nil;local at=ad.map_pri[k(ar,26)]while type(at)~="string"do if not at then return aj(ad)end;if at.maprs then at=at[at.maprs(g(k(ar,21),31),g(k(ar,16),31))]else at=at[g(k(ar,at.shift),at.mask)]or at._ end end;local au,av=c(at,"^([a-z0-9_.]*)(.*)")local aw,ax=c(av,"|([a-z0-9_.|]*)(.*)")if aw then av=ax end;for ay in d(av,".")do local az=nil;if ay=="S"then az=ab[g(k(ar,21),31)]elseif ay=="T"then az=ab[g(k(ar,16),31)]elseif ay=="D"then az=ab[g(k(ar,11),31)]elseif ay=="F"then az="f"..g(k(ar,6),31)elseif ay=="G"then az="f"..g(k(ar,11),31)elseif ay=="H"then az="f"..g(k(ar,16),31)elseif ay=="R"then az="f"..g(k(ar,21),31)elseif ay=="A"then az=g(k(ar,6),31)elseif ay=="a"then az=g(k(ar,6),7)elseif ay=="E"then az=g(k(ar,6),31)+32 elseif ay=="M"then az=g(k(ar,11),31)elseif ay=="N"then az=g(k(ar,16),31)elseif ay=="C"then az=g(k(ar,18),7)if az==0 then az=nil end elseif ay=="K"then az=g(k(ar,11),31)+1 elseif ay=="P"then az=g(k(ar,11),31)+33 elseif ay=="L"then az=g(k(ar,11),31)-as+1 elseif ay=="Q"then az=g(k(ar,11),31)-as+33 elseif ay=="I"then az=l(j(ar,16),16)elseif ay=="2"then az=l(j(ar,13),11)elseif ay=="3"then az=l(j(ar,14),11)elseif ay=="U"then az=g(ar,0xffff)elseif ay=="O"then local aA=l(j(ar,16),16)af[#af]=b("%d(%s)",aA,as)elseif ay=="X"then local aB=ab[g(k(ar,16),31)]af[#af]=b("%s(%s)",aB,as)elseif ay=="B"then az=ad.addr+ad.pos+l(j(ar,16),14)+4;ad.rel=az;az=b("0x%08x",az)elseif ay=="b"then az=ad.addr+ad.pos+l(j(ar,11),9)+4;ad.rel=az;az=b("0x%08x",az)elseif ay=="#"then az=ad.addr+ad.pos+l(j(ar,6),4)+4;ad.rel=az;az=b("0x%08x",az)elseif ay=="J"then local aC=ad.addr+ad.pos;az=aC-g(aC,0x0fffffff)+g(ar,0x03ffffff)*4;ad.rel=az;az=b("0x%08x",az)elseif ay=="V"then az=g(k(ar,8),7)if az==0 then az=nil end elseif ay=="W"then az=g(ar,7)if az==0 then az=nil end elseif ay=="Y"then az=g(k(ar,6),0x000fffff)if az==0 then az=nil end elseif ay=="Z"then az=g(k(ar,6),1023)if az==0 then az=nil end elseif ay=="0"then if as=="r0"or as==0 then local aD=#af;af[aD]=nil;as=af[aD-1]if aw then local aE,aF=c(aw,"([^|]*)|(.*)")if aE then au,aw=aE,aF else au=aw end end end elseif ay=="1"then if as=="ra"then af[#af]=nil end else assert(false)end;if az then af[#af+1]=az;as=az end end;return ac(ad,au,af)end;local function aG(ad,aH,aI)if not aH then aH=0 end;local aJ=aI and aH+aI or#ad.code;aJ=aJ-aJ%4;ad.pos=aH-aH%4;ad.rel=nil;while ad.pos<aJ do aq(ad)end end;local function aK(aL,aM,aN)local ad={}ad.code=aL;ad.addr=aM or 0;ad.out=aN or io.write;ad.symtab={}ad.disass=aG;ad.hexdump=8;ad.get=ak;ad.map_pri=E;return ad end;local function aO(aL,aM,aN)local ad=aK(aL,aM,aN)ad.get=ap;return ad end;local function aP(aL,aM,aN)local ad=aK(aL,aM,aN)ad.map_pri=aa;return ad end;local function aQ(aL,aM,aN)local ad=aK(aL,aM,aN)ad.get=ap;ad.map_pri=aa;return ad end;local function aR(aL,aM,aN)aK(aL,aM,aN):disass()end;local function aS(aL,aM,aN)aO(aL,aM,aN):disass()end;local function aT(aL,aM,aN)aP(aL,aM,aN):disass()end;local function aU(aL,aM,aN)aQ(aL,aM,aN):disass()end;local function aV(aW)if aW<32 then return ab[aW]end;return"f"..aW-32 end;return{create=aK,create_el=aO,create_r6=aP,create_r6_el=aQ,disass=aR,disass_el=aS,disass_r6=aT,disass_r6_el=aU,regname=aV}