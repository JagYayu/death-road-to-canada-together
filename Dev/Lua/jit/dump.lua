----------------------------------------------------------------------------
-- LuaJIT compiler dump module.
--
-- Copyright (C) 2005-2022 Mike Pall. All rights reserved.
-- Released under the MIT license. See Copyright Notice in luajit.h
----------------------------------------------------------------------------
local a=require("jit")assert(a.version_num==20100,"LuaJIT core/library version mismatch")local b=require("jit.util")local c=require("jit.vmdef")local d,e=b.funcinfo,b.funcbc;local f,g,h=b.traceinfo,b.traceir,b.tracek;local i,j=b.tracemc,b.tracesnap;local k,l=b.traceexitstub,b.ircalladdr;local m=require("bit")local n,o,p=m.band,m.rshift,m.tohex;local q,r,s=string.sub,string.gsub,string.format;local t,u=string.byte,string.rep;local type,tostring=type,tostring;local v,w=io.stdout,io.stderr;local x,y;local z,A,B;local C={__index=false}local D={}local E=0;local function F(G,H)local I={}C.__index=I;if a.arch:sub(1,4)=="mips"then I[k(G,0)]="exit"return end;for J=0,H-1 do local K=k(G,J)if K<0 then K=K+2^32 end;I[K]=tostring(J)end;local K=k(G,H)if K then I[K]="stack_check"end end;local function L(G,H)local I=D;if E==0 then local M=a.arch=="arm"and-2;local N=c.ircall;for J=0,#N do local K=l(J)if K~=0 then if M then K=n(K,M)end;if K<0 then K=K+2^32 end;I[K]=N[J]end end end;if E==1000000 then F(G,H)elseif H>E then for J=E,H-1 do local K=k(J)if K==nil then F(G,H)setmetatable(D,C)H=1000000;break end;if K<0 then K=K+2^32 end;I[K]=tostring(J)end;E=H end;return I end;local function O(P)A:write(P)end;local function Q(G)local R=f(G)if not R then return end;local S,K,T=i(G)if not S then return end;if not y then y=require("jit.dis_"..a.arch)end;if K<0 then K=K+2^32 end;A:write("---- TRACE ",G," mcode ",#S,"\n")local U=y.create(S,K,O)U.hexdump=0;U.symtab=L(G,R.nexit)if T~=0 then D[K+T]="LOOP"U:disass(0,T)A:write("->LOOP:\n")U:disass(T,#S-T)D[K+T]=nil else U:disass(0,#S)end end;local V={[0]="nil","fal","tru","lud","str","p32","thr","pro","fun","p64","cdt","tab","udt","flt","num","i8 ","u8 ","i16","u16","int","u32","i64","u64","sfp"}local W={[0]="%s","%s","%s","\027[36m%s\027[m","\027[32m%s\027[m","%s","\027[1m%s\027[m","%s","\027[1m%s\027[m","%s","\027[33m%s\027[m","\027[31m%s\027[m","\027[36m%s\027[m","\027[34m%s\027[m","\027[34m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m","\027[35m%s\027[m"}local function X(P)return P end;local function Y(P,I,Z)local A=s(W[I],P)if Z then A="\027[3m"..A end;return A end;local _=setmetatable({},{__index=function(a0,I)local P=Y(V[I],I)a0[I]=P;return P end})local a1={["<"]="&lt;",[">"]="&gt;",["&"]="&amp;"}local function a2(P,I,Z)P=r(P,"[<>&]",a1)return s('<span class="irt_%s%s">%s</span>',V[I],Z and" irt_extra"or"",P)end;local a3=setmetatable({},{__index=function(a0,I)local P=a2(V[I],I)a0[I]=P;return P end})local a4=[[
<style type="text/css">
background { background: #ffffff; color: #000000; }
pre.ljdump {
font-size: 10pt;
background: #f0f4ff;
color: #000000;
border: 1px solid #bfcfff;
padding: 0.5em;
margin-left: 2em;
margin-right: 2em;
}
span.irt_str { color: #00a000; }
span.irt_thr, span.irt_fun { color: #404040; font-weight: bold; }
span.irt_tab { color: #c00000; }
span.irt_udt, span.irt_lud { color: #00c0c0; }
span.irt_num { color: #4040c0; }
span.irt_int, span.irt_i8, span.irt_u8, span.irt_i16, span.irt_u16 { color: #b040b0; }
span.irt_extra { font-style: italic; }
</style>
]]local a5,a6;local a7={["SLOAD "]=setmetatable({},{__index=function(I,a8)local P=""if n(a8,1)~=0 then P=P.."P"end;if n(a8,2)~=0 then P=P.."F"end;if n(a8,4)~=0 then P=P.."T"end;if n(a8,8)~=0 then P=P.."C"end;if n(a8,16)~=0 then P=P.."R"end;if n(a8,32)~=0 then P=P.."I"end;if n(a8,64)~=0 then P=P.."K"end;I[a8]=P;return P end}),["XLOAD "]={[0]="","R","V","RV","U","RU","VU","RVU"},["CONV  "]=setmetatable({},{__index=function(I,a8)local P=a6[n(a8,31)]P=a6[n(o(a8,5),31)].."."..P;if n(a8,0x800)~=0 then P=P.." sext"end;local a9=o(a8,12)if a9==1 then P=P.." none"elseif a9==2 then P=P.." index"elseif a9==3 then P=P.." check"end;I[a8]=P;return P end}),["FLOAD "]=c.irfield,["FREF  "]=c.irfield,["FPMATH"]=c.irfpm,["TMPREF"]={[0]="","IN","OUT","INOUT","","","OUT2","INOUT2"},["BUFHDR"]={[0]="RESET","APPEND","WRITE"},["TOSTR "]={[0]="INT","NUM","CHAR"}}local function aa(a9)if a9=="\n"then return"\\n"elseif a9=="\r"then return"\\r"elseif a9=="\t"then return"\\t"else return s("\\%03d",t(a9))end end;local function ab(ac,ad)local ae=d(ac,ad)if ae.loc then return ae.loc elseif ae.ffid then return c.ffnames[ae.ffid]elseif ae.addr then return s("C:%x",ae.addr)else return"(?)"end end;local function af(G,ag,ah)local ai,I,aj=h(G,ag)local ak=type(ai)local P;if ak=="number"then if I<12 then P=ai==0 and"NULL"or s("[0x%08x]",ai)elseif n(ah or 0,0x30000)~=0 then P=n(ah,0x20000)~=0 and"contpc"or"ftsz"elseif ai==2^52+2^51 then P="bias"else P=s(0<ai and ai<0x1p-1026 and"%+a"or"%+.14g",ai)end elseif ak=="string"then P=s(#ai>20 and'"%.20s"~'or'"%s"',r(ai,"%c",aa))elseif ak=="function"then P=ab(ai)elseif ak=="table"then P=s("{%p}",ai)elseif ak=="userdata"then if I==12 then P=s("userdata:%p",ai)else P=s("[%p]",ai)if P=="[NULL]"then P="NULL"end end elseif I==21 then P=q(tostring(ai),1,-3)if q(P,1,1)~="-"then P="+"..P end elseif ah==0x1057fff then return"----"else P=tostring(ai)end;P=a5(s("%-4s",P),I,n(ah or 0,0x100000)~=0)if aj then P=s("%s @%d",P,aj)end;return P end;local function al(G,am)local an=2;for P=0,am[1]-1 do local ah=am[an]if o(ah,24)==P then an=an+1;local ao=n(ah,0xffff)-0x8000;if ao<0 then A:write(af(G,ao,ah))elseif n(ah,0x80000)~=0 then A:write(a5(s("%04d/%04d",ao,ao+1),14))else local ap,aq,ar,as=g(G,ao)A:write(a5(s("%04d",ao),n(aq,31),n(ah,0x100000)~=0))end;A:write(n(ah,0x10000)==0 and" "or"|")else A:write("---- ")end end;A:write("]\n")end;local function at(G)A:write("---- TRACE ",G," snapshots\n")for J=0,1000000000 do local am=j(G,J)if not am then break end;A:write(s("#%-3d %04d [ ",J,am[0]))al(G,am)end end;local function au(av,aw)if not y then y=require("jit.dis_"..a.arch)end;local ax,aj=n(av,0xff),o(av,8)if ax==253 or ax==254 then return(aj==0 or aj==255)and" {sink"or s(" {%04d",aw-aj)end;if av>255 then return s("[%x]",aj*4)end;if ax<128 then return y.regname(ax)end;return""end;local function ay(G,aw)local az;if aw>0 then local ap,aq,ar,as=g(G,aw)if n(aq,31)==0 then aw=ar;az=af(G,as)end end;if aw<0 then A:write(s("[0x%x](",tonumber(h(G,aw))))else A:write(s("%04d (",aw))end;return az end;local function aA(G,aw)if aw<0 then A:write(af(G,aw))else local ap,aq,ar,as=g(G,aw)local aB=6*o(aq,8)local aC=q(c.irnames,aB+1,aB+6)if aC=="CARG  "then aA(G,ar)if as<0 then A:write(" ",af(G,as))else A:write(" ",s("%04d",as))end else A:write(s("%04d",aw))end end end;local function aD(G,aE,aF)local R=f(G)if not R then return end;local aG=R.nins;A:write("---- TRACE ",G," IR\n")local aH=c.irnames;local aI=65536;local am,aJ;if aE then am=j(G,0)aI=am[0]aJ=0 end;for aw=1,aG do if aw>=aI then if aF then A:write(s("....              SNAP   #%-3d [ ",aJ))else A:write(s("....        SNAP   #%-3d [ ",aJ))end;al(G,am)aJ=aJ+1;am=j(G,aJ)aI=am and am[0]or 65536 end;local ap,aq,ar,as,av=g(G,aw)local aB,I=6*o(aq,8),n(aq,31)local aC=q(aH,aB+1,aB+6)if aC=="LOOP  "then if aF then A:write(s("%04d ------------ LOOP ------------\n",aw))else A:write(s("%04d ------ LOOP ------------\n",aw))end elseif aC~="NOP   "and aC~="CARG  "and(aF or aC~="RENAME")then local ax=n(av,255)if aF then A:write(s("%04d %-6s",aw,au(av,aw)))else A:write(s("%04d ",aw))end;A:write(s("%s%s %s %s ",(ax==254 or ax==253)and"}"or(n(aq,128)==0 and" "or">"),n(aq,64)==0 and" "or"+",a6[I],aC))local aK,aL=n(ap,3),n(ap,3*4)if q(aC,1,4)=="CALL"then local az;if aL==1*4 then A:write(s("%-10s  (",c.ircall[as]))else az=ay(G,as)end;if ar~=-1 then aA(G,ar)end;A:write(")")if az then A:write(" ctype ",az)end elseif aC=="CNEW  "and as==-1 then A:write(af(G,ar))elseif aK~=3 then if ar<0 then A:write(af(G,ar))else A:write(s(aK==0 and"%04d"or"#%-3d",ar))end;if aL~=3*4 then if aL==1*4 then local aM=a7[aC]if aM and aM[as]then A:write("  ",aM[as])elseif aC=="UREFO "or aC=="UREFC "then A:write(s("  #%-3d",o(as,8)))else A:write(s("  #%-3d",as))end elseif as<0 then A:write("  ",af(G,as))else A:write(s("  %04d",as))end end end;A:write("\n")end end;if am then if aF then A:write(s("....              SNAP   #%-3d [ ",aJ))else A:write(s("....        SNAP   #%-3d [ ",aJ))end;al(G,am)end end;local aN=""local aO=0;local function aP(aQ,R)if type(aQ)=="number"then if type(R)=="function"then R=ab(R)end;aQ=s(c.traceerr[aQ],R)end;return aQ end;local function aR(aS,G,ac,ad,aT,aU)if aS=="stop"or aS=="abort"and B.a then if B.i then aD(G,B.s,B.r and aS=="stop")elseif B.s then at(G)end;if B.m then Q(G)end end;if aS=="start"then if B.H then A:write('<pre class="ljdump">\n')end;A:write("---- TRACE ",G," ",aS)if aT then A:write(" ",aT,"/",aU==-1 and"stitch"or aU)end;A:write(" ",ab(ac,ad),"\n")elseif aS=="stop"or aS=="abort"then A:write("---- TRACE ",G," ",aS)if aS=="abort"then A:write(" ",ab(ac,ad)," -- ",aP(aT,aU),"\n")else local R=f(G)local aV,aW=R.link,R.linktype;if aV==G or aV==0 then A:write(" -> ",aW,"\n")elseif aW=="root"then A:write(" -> ",aV,"\n")else A:write(" -> ",aV," ",aW,"\n")end end;if B.H then A:write("</pre>\n\n")else A:write("\n")end else if aS=="flush"then D,E={},0 end;A:write("---- TRACE ",aS,"\n\n")end;A:flush()end;local function aX(G,ac,ad,aY)if aY~=aO then aO=aY;aN=u(" .",aY)end;local aZ;if ad>=0 then aZ=x(ac,ad,aN)if B.H then aZ=r(aZ,"[<>&]",a1)end else aZ="0000 "..aN.." FUNCC      \n"end;if ad<=0 then A:write(q(aZ,1,-2),"         ; ",ab(ac),"\n")else A:write(aZ)end;if ad>=0 and n(e(ac,ad),0xff)<16 then A:write(x(ac,ad+1,aN))end end;local a_=a.arch:match("64")local b0=a.arch=="mips"or a.arch=="mipsel"local function b1(G,b2,b3,b4,...)A:write("---- TRACE ",G," exit ",b2,"\n")if B.X then local b5={...}if a_ then for J=1,b3 do A:write(s(" %016x",b5[J]))if J%4==0 then A:write("\n")end end else for J=1,b3 do A:write(" ",p(b5[J]))if J%8==0 then A:write("\n")end end end;if b0 then for J=1,b4,2 do A:write(s(" %+17.14g",b5[b3+J]))if J%8==7 then A:write("\n")end end else for J=1,b4 do A:write(s(" %+17.14g",b5[b3+J]))if J%4==0 then A:write("\n")end end end end end;local function b6()if z then z=false;a.attach(b1)a.attach(aX)a.attach(aR)if A and A~=v and A~=w then A:close()end;A=nil end end;local function b7(b8,b9)if z then b6()end;local ba=os.getenv("TERM")local bb=(ba and ba:match("color")or os.getenv("COLORTERM"))and"A"or"T"if b8 then b8=r(b8,"[TAH]",function(a8)bb=a8;return""end)end;local ap={t=true,b=true,i=true,m=true}if b8 and b8~=""then local bc=q(b8,1,1)if bc~="+"and bc~="-"then ap={}end;for J=1,#b8 do ap[q(b8,J,J)]=bc~="-"end end;B=ap;if ap.t or ap.b or ap.i or ap.s or ap.m then a.attach(aR,"trace")end;if ap.b then a.attach(aX,"record")if not x then x=require("jit.bc").line end end;if ap.x or ap.X then a.attach(b1,"texit")end;if not b9 then b9=os.getenv("LUAJIT_DUMPFILE")end;if b9 then A=b9=="-"and v or assert(io.open(b9,"w"))else A=v end;ap[bb]=true;if bb=="A"then a5=Y;a6=_ elseif bb=="H"then a5=a2;a6=a3;A:write(a4)else a5=X;a6=V end;z=true end;return{on=b7,off=b6,start=b7}