----------------------------------------------------------------------------
-- LuaJIT ARM64 disassembler module.
--
-- Copyright (C) 2005-2022 Mike Pall. All rights reserved.
-- Released under the MIT license. See Copyright Notice in luajit.h
--
-- Contributed by Djordje Kovacevic and Stefan Pejic from RT-RK.com.
-- Sponsored by Cisco Systems, Inc.
----------------------------------------------------------------------------
local type=type;local a,b,c=string.sub,string.byte,string.format;local d,e,f=string.match,string.gmatch,string.gsub;local g=table.concat;local h=require("bit")local i,j,k,l=h.band,h.bor,h.bxor,h.tohex;local m,n,o=h.lshift,h.rshift,h.arshift;local p=h.ror;local q={shift=31,mask=1,[0]="adrDBx","adrpDBx"}local r={shift=29,mask=3,[0]="add|movDNIg","adds|cmnD0NIg","subDNIg","subs|cmpD0NIg"}local s={shift=31,mask=1,[0]={shift=22,mask=1,[0]={shift=29,mask=3,[0]="andDNig","orr|movDN0ig","eorDNig","ands|tstD0Nig"},false},{shift=29,mask=3,[0]="andDNig","orr|movDN0ig","eorDNig","ands|tstD0Nig"}}local t={shift=31,mask=1,[0]={shift=22,mask=1,[0]={shift=29,mask=3,[0]="movnDWRg",false,"movz|movDYRg","movkDWRg"},false},{shift=29,mask=3,[0]="movnDWRg",false,"movz|movDYRg","movkDWRg"}}local u={shift=31,mask=1,[0]={shift=22,mask=1,[0]={shift=29,mask=3,[0]="sbfm|sbfiz|sbfx|asr|sxtw|sxth|sxtbDN12w","bfm|bfi|bfxilDN13w","ubfm|ubfiz|ubfx|lsr|lsl|uxth|uxtbDN12w"}},{shift=22,mask=1,{shift=29,mask=3,[0]="sbfm|sbfiz|sbfx|asr|sxtw|sxth|sxtbDN12x","bfm|bfi|bfxilDN13x","ubfm|ubfiz|ubfx|lsr|lsl|uxth|uxtbDN12x"}}}local v={shift=23,mask=7,[0]=q,q,r,false,s,t,u,{shift=15,mask=0x1c0c1,[0]="extr|rorDNM4w",[0x10080]="extr|rorDNM4x",[0x10081]="extr|rorDNM4x"}}local w={shift=31,mask=1,[0]={shift=15,mask=1,[0]={shift=29,mask=3,[0]={shift=21,mask=7,[0]="andDNMSg","bicDNMSg","andDNMSg","bicDNMSg","andDNMSg","bicDNMSg","andDNMg","bicDNMg"},{shift=21,mask=7,[0]="orr|movDN0MSg","orn|mvnDN0MSg","orr|movDN0MSg","orn|mvnDN0MSg","orr|movDN0MSg","orn|mvnDN0MSg","orr|movDN0Mg","orn|mvnDN0Mg"},{shift=21,mask=7,[0]="eorDNMSg","eonDNMSg","eorDNMSg","eonDNMSg","eorDNMSg","eonDNMSg","eorDNMg","eonDNMg"},{shift=21,mask=7,[0]="ands|tstD0NMSg","bicsDNMSg","ands|tstD0NMSg","bicsDNMSg","ands|tstD0NMSg","bicsDNMSg","ands|tstD0NMg","bicsDNMg"}},false},{shift=29,mask=3,[0]={shift=21,mask=7,[0]="andDNMSg","bicDNMSg","andDNMSg","bicDNMSg","andDNMSg","bicDNMSg","andDNMg","bicDNMg"},{shift=21,mask=7,[0]="orr|movDN0MSg","orn|mvnDN0MSg","orr|movDN0MSg","orn|mvnDN0MSg","orr|movDN0MSg","orn|mvnDN0MSg","orr|movDN0Mg","orn|mvnDN0Mg"},{shift=21,mask=7,[0]="eorDNMSg","eonDNMSg","eorDNMSg","eonDNMSg","eorDNMSg","eonDNMSg","eorDNMg","eonDNMg"},{shift=21,mask=7,[0]="ands|tstD0NMSg","bicsDNMSg","ands|tstD0NMSg","bicsDNMSg","ands|tstD0NMSg","bicsDNMSg","ands|tstD0NMg","bicsDNMg"}}}local x={shift=31,mask=1,[0]={shift=15,mask=1,[0]={shift=29,mask=3,[0]={shift=22,mask=3,[0]="addDNMSg","addDNMSg","addDNMSg","addDNMg"},{shift=22,mask=3,[0]="adds|cmnD0NMSg","adds|cmnD0NMSg","adds|cmnD0NMSg","adds|cmnD0NMg"},{shift=22,mask=3,[0]="sub|negDN0MSg","sub|negDN0MSg","sub|negDN0MSg","sub|negDN0Mg"},{shift=22,mask=3,[0]="subs|cmp|negsD0N0MzSg","subs|cmp|negsD0N0MzSg","subs|cmp|negsD0N0MzSg","subs|cmp|negsD0N0Mzg"}},false},{shift=29,mask=3,[0]={shift=22,mask=3,[0]="addDNMSg","addDNMSg","addDNMSg","addDNMg"},{shift=22,mask=3,[0]="adds|cmnD0NMSg","adds|cmnD0NMSg","adds|cmnD0NMSg","adds|cmnD0NMg"},{shift=22,mask=3,[0]="sub|negDN0MSg","sub|negDN0MSg","sub|negDN0MSg","sub|negDN0Mg"},{shift=22,mask=3,[0]="subs|cmp|negsD0N0MzSg","subs|cmp|negsD0N0MzSg","subs|cmp|negsD0N0MzSg","subs|cmp|negsD0N0Mzg"}}}local y={shift=22,mask=3,[0]=x,x,x}local z={shift=22,mask=3,[0]={shift=29,mask=3,[0]="addDNMXg","adds|cmnD0NMXg","subDNMXg","subs|cmpD0NMzXg"}}local A={shift=10,mask=63,[0]={shift=29,mask=3,[0]="adcDNMg","adcsDNMg","sbc|ngcDN0Mg","sbcs|ngcsDN0Mg"}}local B={shift=4,mask=1,[0]={shift=10,mask=3,[0]={shift=29,mask=3,"ccmnNMVCg",false,"ccmpNMVCg"},[2]={shift=29,mask=3,"ccmnN5VCg",false,"ccmpN5VCg"}}}local C={shift=11,mask=1,[0]={shift=10,mask=1,[0]={shift=29,mask=3,[0]="cselDNMzCg",false,"csinv|cinv|csetmDNMcg",false},{shift=29,mask=3,[0]="csinc|cinc|csetDNMcg",false,"csneg|cnegDNMcg",false}}}local D={shift=29,mask=1,[0]={shift=31,mask=1,[0]={shift=10,mask=0x7ff,[0]="rbitDNg","rev16DNg","revDNw",false,"clzDNg","clsDNg"},{shift=10,mask=0x7ff,[0]="rbitDNg","rev16DNg","rev32DNx","revDNx","clzDNg","clsDNg"}}}local E={shift=29,mask=1,[0]={shift=10,mask=63,false,"udivDNMg","sdivDNMg",false,false,false,false,"lslDNMg","lsrDNMg","asrDNMg","rorDNMg"}}local F={shift=29,mask=7,[0]={shift=21,mask=7,[0]={shift=15,mask=1,[0]="madd|mulDNMA0g","msub|mnegDNMA0g"}},false,false,false,{shift=15,mask=1,[0]={shift=21,mask=7,[0]="madd|mulDNMA0g","smaddl|smullDxNMwA0x","smulhDNMx",false,false,"umaddl|umullDxNMwA0x","umulhDNMx"},{shift=21,mask=7,[0]="msub|mnegDNMA0g","smsubl|smneglDxNMwA0x",false,false,false,"umsubl|umneglDxNMwA0x"}}}local G={shift=28,mask=1,[0]={shift=24,mask=1,[0]=w,{shift=21,mask=1,[0]=y,z}},{shift=21,mask=15,[0]=A,false,B,false,C,false,{shift=30,mask=1,[0]=E,D},false,F,F,F,F,F,F,F,F}}local H={shift=26,mask=1,[0]={shift=30,mask=3,[0]="ldrDwB","ldrDxB","ldrswDxB"},{shift=30,mask=3,[0]="ldrDsB","ldrDdB"}}local I={shift=30,mask=3,[0]={shift=26,mask=1,[0]={shift=22,mask=3,[0]="strbDwzL","ldrbDwzL","ldrsbDxzL","ldrsbDwzL"}},{shift=26,mask=1,[0]={shift=22,mask=3,[0]="strhDwzL","ldrhDwzL","ldrshDxzL","ldrshDwzL"}},{shift=26,mask=1,[0]={shift=22,mask=3,[0]="strDwzL","ldrDwzL","ldrswDxzL"},{shift=22,mask=3,[0]="strDszL","ldrDszL"}},{shift=26,mask=1,[0]={shift=22,mask=3,[0]="strDxzL","ldrDxzL"},{shift=22,mask=3,[0]="strDdzL","ldrDdzL"}}}local J={shift=21,mask=1,[0]={shift=10,mask=3,[0]={shift=26,mask=1,[0]={shift=30,mask=3,[0]={shift=22,mask=3,[0]="sturbDwK","ldurbDwK"},{shift=22,mask=3,[0]="sturhDwK","ldurhDwK"},{shift=22,mask=3,[0]="sturDwK","ldurDwK"},{shift=22,mask=3,[0]="sturDxK","ldurDxK"}}},I,false,I},{shift=10,mask=3,[2]={shift=26,mask=1,[0]={shift=30,mask=3,[0]={shift=22,mask=3,[0]="strbDwO","ldrbDwO","ldrsbDxO","ldrsbDwO"},{shift=22,mask=3,[0]="strhDwO","ldrhDwO","ldrshDxO","ldrshDwO"},{shift=22,mask=3,[0]="strDwO","ldrDwO","ldrswDxO"},{shift=22,mask=3,[0]="strDxO","ldrDxO"}},{shift=30,mask=3,[2]={shift=22,mask=3,[0]="strDsO","ldrDsO"},[3]={shift=22,mask=3,[0]="strDdO","ldrDdO"}}}}}local K={shift=22,mask=1,[0]={shift=30,mask=3,[0]={shift=26,mask=1,[0]="stpDzAzwP","stpDzAzsP"},{shift=26,mask=1,"stpDzAzdP"},{shift=26,mask=1,[0]="stpDzAzxP"}},{shift=30,mask=3,[0]={shift=26,mask=1,[0]="ldpDzAzwP","ldpDzAzsP"},{shift=26,mask=1,[0]="ldpswDAxP","ldpDzAzdP"},{shift=26,mask=1,[0]="ldpDzAzxP"}}}local L={shift=24,mask=0x31,[0x10]=H,[0x30]=J,[0x20]={shift=23,mask=3,K,K,K},[0x21]={shift=23,mask=3,K,K,K},[0x31]={shift=26,mask=1,[0]={shift=30,mask=3,[0]={shift=22,mask=3,[0]="strbDwzU","ldrbDwzU"},{shift=22,mask=3,[0]="strhDwzU","ldrhDwzU"},{shift=22,mask=3,[0]="strDwzU","ldrDwzU"},{shift=22,mask=3,[0]="strDxzU","ldrDxzU"}},{shift=30,mask=3,[2]={shift=22,mask=3,[0]="strDszU","ldrDszU"},[3]={shift=22,mask=3,[0]="strDdzU","ldrDdzU"}}}}local M={shift=28,mask=7,{shift=24,mask=1,[0]={shift=21,mask=1,{shift=10,mask=3,[0]={shift=12,mask=1,[0]={shift=13,mask=1,[0]={shift=14,mask=1,[0]={shift=15,mask=1,[0]={shift=31,mask=1,[0]={shift=16,mask=0xff,[0x20]="fcvtnsDwNs",[0x21]="fcvtnuDwNs",[0x22]="scvtfDsNw",[0x23]="ucvtfDsNw",[0x24]="fcvtasDwNs",[0x25]="fcvtauDwNs",[0x26]="fmovDwNs",[0x27]="fmovDsNw",[0x28]="fcvtpsDwNs",[0x29]="fcvtpuDwNs",[0x30]="fcvtmsDwNs",[0x31]="fcvtmuDwNs",[0x38]="fcvtzsDwNs",[0x39]="fcvtzuDwNs",[0x60]="fcvtnsDwNd",[0x61]="fcvtnuDwNd",[0x62]="scvtfDdNw",[0x63]="ucvtfDdNw",[0x64]="fcvtasDwNd",[0x65]="fcvtauDwNd",[0x68]="fcvtpsDwNd",[0x69]="fcvtpuDwNd",[0x70]="fcvtmsDwNd",[0x71]="fcvtmuDwNd",[0x78]="fcvtzsDwNd",[0x79]="fcvtzuDwNd"},{shift=16,mask=0xff,[0x20]="fcvtnsDxNs",[0x21]="fcvtnuDxNs",[0x22]="scvtfDsNx",[0x23]="ucvtfDsNx",[0x24]="fcvtasDxNs",[0x25]="fcvtauDxNs",[0x28]="fcvtpsDxNs",[0x29]="fcvtpuDxNs",[0x30]="fcvtmsDxNs",[0x31]="fcvtmuDxNs",[0x38]="fcvtzsDxNs",[0x39]="fcvtzuDxNs",[0x60]="fcvtnsDxNd",[0x61]="fcvtnuDxNd",[0x62]="scvtfDdNx",[0x63]="ucvtfDdNx",[0x64]="fcvtasDxNd",[0x65]="fcvtauDxNd",[0x66]="fmovDxNd",[0x67]="fmovDdNx",[0x68]="fcvtpsDxNd",[0x69]="fcvtpuDxNd",[0x70]="fcvtmsDxNd",[0x71]="fcvtmuDxNd",[0x78]="fcvtzsDxNd",[0x79]="fcvtzuDxNd"}}},{shift=31,mask=1,[0]={shift=22,mask=3,[0]={shift=15,mask=63,[0]="fmovDNf","fabsDNf","fnegDNf","fsqrtDNf",false,"fcvtDdNs",false,false,"frintnDNf","frintpDNf","frintmDNf","frintzDNf","frintaDNf",false,"frintxDNf","frintiDNf"},{shift=15,mask=63,[0]="fmovDNf","fabsDNf","fnegDNf","fsqrtDNf","fcvtDsNd",false,false,false,"frintnDNf","frintpDNf","frintmDNf","frintzDNf","frintaDNf",false,"frintxDNf","frintiDNf"}}}},{shift=31,mask=1,[0]={shift=14,mask=3,[0]={shift=23,mask=1,[0]={shift=0,mask=31,[0]="fcmpNMf",[8]="fcmpNZf",[16]="fcmpeNMf",[24]="fcmpeNZf"}}}}},{shift=31,mask=1,[0]={shift=5,mask=31,[0]={shift=23,mask=1,[0]="fmovDFf"}}}},{shift=31,mask=1,[0]={shift=23,mask=1,[0]={shift=4,mask=1,[0]="fccmpNMVCf","fccmpeNMVCf"}}},{shift=31,mask=1,[0]={shift=23,mask=1,[0]={shift=12,mask=15,[0]="fmulDNMf","fdivDNMf","faddDNMf","fsubDNMf","fmaxDNMf","fminDNMf","fmaxnmDNMf","fminnmDNMf","fnmulDNMf"}}},{shift=31,mask=1,[0]={shift=23,mask=1,[0]="fcselDNMCf"}}}},{shift=31,mask=1,[0]={shift=15,mask=1,[0]={shift=21,mask=5,[0]="fmaddDNMAf","fnmaddDNMAf"},{shift=21,mask=5,[0]="fmsubDNMAf","fnmsubDNMAf"}}}}}local N={shift=29,mask=7,[0]="bB",{shift=24,mask=3,[0]="cbzDBg","cbnzDBg","tbzDTBw","tbnzDTBw"},{shift=24,mask=3,[0]={shift=4,mask=1,[0]={shift=0,mask=15,[0]="beqB","bneB","bhsB","bloB","bmiB","bplB","bvsB","bvcB","bhiB","blsB","bgeB","bltB","bgtB","bleB","balB"}}},false,"blB",{shift=24,mask=3,[0]="cbzDBg","cbnzDBg","tbzDTBx","tbnzDTBx"},{shift=24,mask=3,[0]={shift=0,mask=0xe0001f,[0x200000]="brkW"},{shift=0,mask=0x3fffff,[0x03201f]="nop"},{shift=0,mask=0xfffc1f,[0x1f0000]="brNx",[0x3f0000]="blrNx",[0x5f0000]="retNx"}}}local O={shift=25,mask=15,[0]=false,false,false,false,L,G,L,M,v,v,N,N,L,G,L,M}local P={x={},w={},d={},s={}}for Q=0,30 do P.x[Q]="x"..Q;P.w[Q]="w"..Q;P.d[Q]="d"..Q;P.s[Q]="s"..Q end;P.x[31]="sp"P.w[31]="wsp"P.d[31]="d31"P.s[31]="s31"local R={[0]="eq","ne","cs","cc","mi","pl","vs","vc","hi","ls","ge","lt","gt","le","al"}local S={[0]="lsl","lsr","asr"}local T={[0]="uxtb","uxth","uxtw","uxtx","sxtb","sxth","sxtw","sxtx"}local function U(V,W,X)local Y=V.pos;local Z=""if V.rel then local _=V.symtab[V.rel]if _ then Z="\t->".._ end end;if V.hexdump>0 then V.out(c("%08x  %s  %-5s %s%s\n",V.addr+Y,l(V.op),W,g(X,", "),Z))else V.out(c("%08x  %-5s %s%s\n",V.addr+Y,W,g(X,", "),Z))end;V.pos=Y+4 end;local function a0(V)return U(V,".long",{"0x"..l(V.op)})end;local function a1(a2,a3,a4)return P[d(a3,a2 .."%w-([xwds])")][a4]end;local function a5(a6)if a6<0 then return l(a6)else return c("%x",a6)end end;local a7={0x55555555,0x11111111,0x01010101,0x00010001,0x00000001}local function a8(a9)local aa=i(n(a9,10),63)local ab=i(n(a9,16),63)if i(a9,0x00400000)==0 then local ac=5;if aa>=56 then if aa>=60 then ac=1 else ac=2 end elseif aa>=48 then ac=3 elseif aa>=32 then ac=4 end;local ad=m(1,ac)-1;local ae=i(aa,ad)local af=i(ab,ad)local ag=p(n(-1,31-ae),af)if ac~=5 then ag=i(ag,m(1,ad)-1)+n(ag,31-ad)end;ag=ag*a7[ac]local ah=a5(ag)if n(a9,31)~=0 then return ah..l(ag)else return ah end else local ai,aj=-1,0;if aa<32 then ai=n(-1,31-aa)else aj=n(-1,63-aa)end;if ab~=0 then ai,aj=p(ai,ab),p(aj,ab)local a6=ab==32 and 0 or i(k(ai,aj),m(-1,32-ab))ai,aj=k(ai,a6),k(aj,a6)if ab>=32 then ai,aj=aj,ai end end;if aj~=0 then return a5(aj)..l(ai)else return a5(ai)end end end;local function ak(a9,al)if al=="b"or al=="bl"then return o(m(a9,6),4)elseif al=="adr"or al=="adrp"then local am=i(n(a9,29),3)local an=m(o(m(a9,8),13),2)return j(an,am)elseif al=="tbz"or al=="tbnz"then return m(o(m(a9,13),18),2)else return m(o(m(a9,8),13),2)end end;local function ao(a9)local ap=i(a9,0x100000)==0 and 1 or-1;local aq=k(n(o(m(a9,12),5),24),0x80)-131;local ar=16+i(n(a9,13),15)return ap*ar*2^aq end;local function as(at,au,aa,ab)if aa<ab or aa==31 or aa==63 then return false end;if ab==0 then if at==0 and(aa==7 or aa==15)then return false end;if at~=0 and au==0 and(aa==7 or aa==15 or aa==31)then return false end end;return true end;local function av(V)local Y=V.pos;local aw,ax,ay,az=b(V.code,Y+1,Y+4)local a9=j(m(az,24),m(ay,16),m(ax,8),aw)local X={}local aA=""local aB,al,a3;local aC;V.op=a9;V.rel=nil;aB=nil;local aD;aD=O[i(n(a9,25),15)]while type(aD)~="string"do if not aD then return a0(V)end;aD=aD[i(n(a9,aD.shift),aD.mask)]or aD._ end;al,a3=d(aD,"^([a-z0-9]*)(.*)")local aE,aF=d(a3,"|([a-z0-9_.|]*)(.*)")if aE then a3=aF end;if a(a3,1,1)=="."then local aG,aH=d(a3,"^([a-z0-9.]*)(.*)")aA=aA..aG;a3=aH end;local aI=d(a3,"[gf]")if aI then if aI=="g"then aC=i(a9,0x80000000)~=0 and P.x or P.w else aC=i(a9,0x400000)~=0 and P.d or P.s end end;local aJ,ab;for a2 in e(a3,".")do local a6=nil;if a2=="D"then local a4=i(a9,31)a6=aI and aC[a4]or a1(a2,a3,a4)elseif a2=="N"then local a4=i(n(a9,5),31)a6=aI and aC[a4]or a1(a2,a3,a4)elseif a2=="M"then local a4=i(n(a9,16),31)a6=aI and aC[a4]or a1(a2,a3,a4)elseif a2=="A"then local a4=i(n(a9,10),31)a6=aI and aC[a4]or a1(a2,a3,a4)elseif a2=="B"then local aK=V.addr+Y+ak(a9,al)V.rel=aK;a6="0x"..l(aK)elseif a2=="T"then a6=j(i(n(a9,26),32),i(n(a9,19),31))elseif a2=="V"then a6=i(a9,15)elseif a2=="C"then a6=R[i(n(a9,12),15)]elseif a2=="c"then local aL=i(n(a9,5),31)local aM=i(n(a9,16),31)local aN=i(n(a9,12),15)local aO=k(aN,1)a6=R[aN]if aE and aN~=14 and aN~=15 then local aP,aQ=d(aE,"([^|]*)|(.*)")if aL==aM then local aR=#X;X[aR]=nil;a6=R[aO]if aL~=31 then if aP then al=aP else al=aE end else X[aR-1]=nil;al=aQ end end end elseif a2=="W"then a6=i(n(a9,5),0xffff)elseif a2=="Y"then a6=i(n(a9,5),0xffff)local aS=i(n(a9,21),3)if aE and(aS==0 or a6~=0)then al=aE end elseif a2=="L"then local aL=P.x[i(n(a9,5),31)]local aT=o(m(a9,11),23)if i(a9,0x800)~=0 then a6="["..aL..", #"..aT.."]!"else a6="["..aL.."], #"..aT end elseif a2=="U"then local aL=P.x[i(n(a9,5),31)]local aU=i(n(a9,30),3)local aV=m(o(m(a9,10),20),aU)if aV~=0 then a6="["..aL..", #"..aV.."]"else a6="["..aL.."]"end elseif a2=="K"then local aL=P.x[i(n(a9,5),31)]local aT=o(m(a9,11),23)if aT~=0 then a6="["..aL..", #"..aT.."]"else a6="["..aL.."]"end elseif a2=="O"then local aL,aM=P.x[i(n(a9,5),31)]local aW=i(n(a9,13),1)if aW==0 then aM=P.w[i(n(a9,16),31)]else aM=P.x[i(n(a9,16),31)]end;a6="["..aL..", "..aM;local aX=i(n(a9,13),7)local ae=i(n(a9,12),1)local aU=i(n(a9,30),3)if aX==3 then if ae==0 then a6=a6 .."]"else a6=a6 ..", lsl #"..aU.."]"end elseif aX==2 or aX==6 or aX==7 then if ae==0 then a6=a6 ..", "..T[aX].."]"else a6=a6 ..", "..T[aX].." #"..aU.."]"end else a6=a6 .."]"end elseif a2=="P"then local aY,aZ=n(a9,26),2;if aY>=0x2a then aZ=4 elseif aY>=0x1b then aZ=3 end;local a_=m(o(m(a9,10),25),aZ)local aL=P.x[i(n(a9,5),31)]local b0=i(n(a9,23),3)if b0==1 then a6="["..aL.."], #"..a_ elseif b0==2 then if a_==0 then a6="["..aL.."]"else a6="["..aL..", #"..a_.."]"end elseif b0==3 then a6="["..aL..", #"..a_.."]!"end elseif a2=="I"then local b1=i(n(a9,22),3)local aV=i(n(a9,10),0x0fff)local aL,b2=i(n(a9,5),31),i(a9,31)if aE=="mov"and b1==0 and aV==0 and(aL==31 or b2==31)then al=aE;a6=nil elseif b1==0 then a6=aV elseif b1==1 then a6=aV..", lsl #12"end elseif a2=="i"then a6="#0x"..a8(a9)elseif a2=="1"then ab=i(n(a9,16),63)a6=ab elseif a2=="2"then a6=i(n(a9,10),63)if aE then local aP,aQ,b3,b4,b5,b6=d(aE,"([^|]*)|([^|]*)|([^|]*)|([^|]*)|([^|]*)|(.*)")local at=i(n(a9,26),32)local au=i(n(a9,30),1)if as(at,au,a6,ab)then al=aQ;a6=a6-ab+1 elseif ab==0 and a6==7 then local aR=#X;X[aR]=nil;if at~=0 then X[aR-1]=f(X[aR-1],"x","w")end;aB=X[aR-1]al=b6;a6=nil elseif ab==0 and a6==15 then local aR=#X;X[aR]=nil;if at~=0 then X[aR-1]=f(X[aR-1],"x","w")end;aB=X[aR-1]al=b5;a6=nil elseif a6==31 or a6==63 then if a6==31 and ab==0 and al=="sbfm"then al=b4;local aR=#X;X[aR]=nil;if at~=0 then X[aR-1]=f(X[aR-1],"x","w")end;aB=X[aR-1]else al=b3 end;a6=nil elseif i(a6,31)~=31 and ab==a6+1 and al=="ubfm"then al=b4;aB="#"..at+32-ab;X[#X]=aB;a6=nil elseif a6<ab then al=aP;aB="#"..at+32-ab;X[#X]=aB;a6=a6+1 end end elseif a2=="3"then a6=i(n(a9,10),63)if aE then local aP,aQ=d(aE,"([^|]*)|(.*)")if a6<ab then al=aP;local at=i(n(a9,26),32)aB="#"..at+32-ab;X[#X]=aB;a6=a6+1 else al=aQ;a6=a6-ab+1 end end elseif a2=="4"then a6=i(n(a9,10),63)local aL=i(n(a9,5),31)local aM=i(n(a9,16),31)if aE and aL==aM then local aR=#X;X[aR]=nil;aB=X[aR-1]al=aE end elseif a2=="5"then a6=i(n(a9,16),31)elseif a2=="S"then a6=i(n(a9,10),63)if a6==0 then a6=nil else a6=S[i(n(a9,22),3)].." #"..a6 end elseif a2=="X"then local aX=i(n(a9,13),7)if aX~=3 and aX~=7 then aB=P.w[i(n(a9,16),31)]X[#X]=aB end;a6=i(n(a9,10),7)if aX==2+i(n(a9,31),1)and i(n(a9,aJ and 5 or 0),31)==31 then if a6==0 then a6=nil else a6="lsl #"..a6 end else if a6==0 then a6=T[i(n(a9,13),7)]else a6=T[i(n(a9,13),7)].." #"..a6 end end elseif a2=="R"then a6=i(n(a9,21),3)if a6==0 then a6=nil else a6="lsl #"..a6*16 end elseif a2=="z"then local aR=#X;if X[aR]=="sp"then X[aR]="xzr"elseif X[aR]=="wsp"then X[aR]="wzr"end elseif a2=="Z"then a6=0 elseif a2=="F"then a6=ao(a9)elseif a2=="g"or a2=="f"or a2=="x"or a2=="w"or a2=="d"or a2=="s"then elseif a2=="0"then if aB=="sp"or aB=="wsp"then local aR=#X;X[aR]=nil;aB=X[aR-1]if aE then local aP,aQ=d(aE,"([^|]*)|(.*)")if not aP then al=aE elseif aJ then al,aE=aQ,aP else al,aE=aP,aQ end end end;aJ=true else assert(false)end;if a6 then aB=a6;if type(a6)=="number"then a6="#"..a6 end;X[#X+1]=a6 end end;return U(V,al..aA,X)end;local function b7(V,b8,ac)if not b8 then b8=0 end;local b9=ac and b8+ac or#V.code;V.pos=b8;V.rel=nil;while V.pos<b9 do av(V)end end;local function ba(bb,aK,bc)local V={}V.code=bb;V.addr=aK or 0;V.out=bc or io.write;V.symtab={}V.disass=b7;V.hexdump=8;return V end;local function bd(bb,aK,bc)ba(bb,aK,bc):disass()end;local function be(af)if af<32 then return P.x[af]end;return P.d[af-32]end;return{create=ba,disass=bd,regname=be}